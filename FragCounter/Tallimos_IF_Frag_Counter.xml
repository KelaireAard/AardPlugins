<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Thursday, June 24, 2021, 1:06 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Tallimos_IF_Frag_Counter" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Tallimos_IF_Frag_Counter"
   author="Tallimos"
   id="e7b8380eaba4b9b8b45a4ea5"
   language="Lua"
   purpose="Displays the number of icefall fragments in your current room"
   save_state="y"
   date_written="2021-06-24 13:05:27"
   requires="4.73"
   version="1.1"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<triggers>
	  <trigger
		enabled="y"
		group="IceFall_Epic"
		match="^An energized ruby fragment flies (\w+)\."
		regexp="y"
		script="IcefallFragMovement"
		sequence="100"
		omit_from_output="y"
		>
	</trigger>
	<trigger
		enabled="n"
		script="IFFragConsiderOff"
		group="epicconsider"
		match="^IFFrag Consider Over$"
		name="IFFragConsiderOff"
		regexp="y"
		sequence="100"
		omit_from_output="y"
		>
	</trigger>
-- Epic Consider Triggers
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?You would stomp (?<mob>.+) into the ground\.$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) would be easy\, but is it even worth the work out\?$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?No Problem\! (?<mob>.+) is weak compared to you\.$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) looks a little worried about the idea\.$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) should be a fair fight\!$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) snickers nervously\.$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) chuckles at the thought of you fighting \b.+\b\.$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"	
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?Best run away from (?<mob>.+) while you can\!$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?Challenging (?<mob>.+) would be either very brave or very stupid\.$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) would crush you like a bug\!$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) would dance on your grave\!$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?(?<mob>.+) says 'BEGONE FROM MY SIGHT unworthy\!'$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
	<trigger
		enabled="n"
		match="^(?:\(.*\) )?You would be completely annihilated by (?<mob>.+)\!$"
		regexp="y"
		group="epicconsider"
		script="Epic_Consider"
		sequence="100"
		omit_from_output="y"
		omit_from_log="y"
		>
	</trigger>
</triggers>

<aliases>
	<alias
		script="IFFragConsiderOn"
		match="^(tif|iffrag|ifrag)$"
		enabled="y"
		ignore_case="y"
		regexp="y"
		sequence="200"
		>
	</alias>
	<alias
		script="tif_help"
		match="^tif help$"
		enabled="y"
		ignore_case="y"
		regexp="y"
		sequence="200"
		>
	</alias>
	<alias
		script="SetReportChannel"
		match="^(?:tif|iffrag|ifrag) (?:report|channel) (.*?)$"
		enabled="y"
		ignore_case="y"
		regexp="y"
		sequence="200"
		>
	</alias>
	<alias
		script="DisplayReportChannel"
		match="^(?:tif|iffrag|ifrag) (?:report|channel)$"
		enabled="y"
		ignore_case="y"
		regexp="y"
		sequence="200"
		>
	</alias>
</aliases>

<!--  Script  -->

<script>

<![CDATA[
require "tprint"
require "mw_theme_base"
require "serialize"
require "commas"
require "gmcphelper"
require "copytable"
require "aardmapper"
require "aard_lua_extras"

----------------------------START OF VARIABLE DECLARATIONS----------------------------

local msg_colour      = "lightslategrey"
local err_colour      = "firebrick"
local help_colour     = "lightslategrey"
local qty_colour      = "cyan"
local optional_colour = "lightcoral"
local command_colour  = "white"
local cmd_required    = "royalblue"
local help_command_colour  = "red"

local noteline = "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="

-- GetRoom Variables
local gmcparea = ""
local gmcproomid = 0

-- Icefall Frag Counter Variables
IFFragCount = 0

--------------------------------------------------
------------ REPORT CHANNEL FUNCTIONS ------------
--------------------------------------------------
function SetReportChannel(name, line, wc)
	if wc[1] ~= nil then
		reportchannel = wc[1]
		
		ColourNote (msg_colour, "", "Report Channel has been changed to ", qty_colour, "", wc[1])
	
		SaveState()
	end
end

function DisplayReportChannel()
	if reportchannel == nil or reportchannel == "" then
		ColourNote (err_colour, "", "No Report Channel has been set.")
	else
		ColourNote (msg_colour, "", "Report Channel: ", qty_colour, "", reportchannel)
	end
end

--------------------------------------------------
--------- ICEFALL FRAG COUNTER FUNCTIONS ---------
--------------------------------------------------
function IFFragConsiderOn()
	world.EnableGroup ("epicconsider", 1)
	
	SendNoEcho ("consider")
	SendNoEcho ("echo IFFrag Consider Over")
	
	IFFragCount = 0
end

function IFFragConsiderOff()
	world.EnableGroup ("epicconsider", 0)	
	
	DisplayIFFragConsider()	
end

function DisplayIFFragConsider()
	GetRoom()
	
	local location = ""
	
	-- 7 x 6 Grid 
	-- 38806 (5n3w) 38807 (5n2w) 38808 (5n1w) 38809 (5n) 38810 (5n1e) 38811 (5n2e) 38812 (5n3e)
	-- 38799 (4n3w) 38800 (4n2w) 38801 (4n1w) 38802 (4n) 38803 (4n1e) 38804 (4n2e) 38805 (4n3e)
	-- 38792 (3n3w) 38793 (3n2w) 38794 (3n1w) 38795 (3n) 38796 (3n1e) 38797 (3n2e) 38798 (3n3e)
	-- 38785 (2n3w) 38786 (2n2w) 38787 (2n1w) 38788 (2n) 38789 (2n1e) 38790 (2n2e) 38791 (2n3e)
	-- 38778 (1n3w) 38779 (1n2w) 38780 (1n1w) 38781 (1n) 38782 (1n1e) 38783 (1n2e) 38784 (1n3e)
	-- 38771 (0n3w) 38772 (0n2w) 38773 (0n1w) 38774 (0n) 38775 (0n1e) 38776 (0n2e) 38777 (0n3e)
		
	-- 0n - 38771 - 38777
	if tonumber(gmcproomid) == 38771 then
		location = "0n3w"
	elseif tonumber(gmcproomid) == 38772 then
		location = "0n2w"
	elseif tonumber(gmcproomid) == 38773 then
		location = "0n1w"
	elseif tonumber(gmcproomid) == 38774 then
		location = "0n"
	elseif tonumber(gmcproomid) == 38775 then
		location = "0n1e"
	elseif tonumber(gmcproomid) == 38776 then
		location = "0n2e"
	elseif tonumber(gmcproomid) == 38777 then
		location = "0n3e"
	-- 1n - 38778 - 38784
	elseif tonumber(gmcproomid) == 38778 then
		location = "1n3w"
	elseif tonumber(gmcproomid) == 38779 then
		location = "1n2w"
	elseif tonumber(gmcproomid) == 38780 then
		location = "1n1w"
	elseif tonumber(gmcproomid) == 38781 then
		location = "1n"
	elseif tonumber(gmcproomid) == 38782 then
		location = "1n1e"
	elseif tonumber(gmcproomid) == 38783 then
		location = "1n2e"
	elseif tonumber(gmcproomid) == 38784 then
		location = "1n3e"
	-- 2n - 38785 - 38791
	elseif tonumber(gmcproomid) == 38785 then
		location = "2n3w"
	elseif tonumber(gmcproomid) == 38786 then
		location = "2n2w"
	elseif tonumber(gmcproomid) == 38787 then
		location = "2n1w"
	elseif tonumber(gmcproomid) == 38788 then
		location = "2n"
	elseif tonumber(gmcproomid) == 38789 then
		location = "2n1e"
	elseif tonumber(gmcproomid) == 38790 then
		location = "2n2e"
	elseif tonumber(gmcproomid) == 38791 then
		location = "2n3e"
	-- 3n - 38792 - 38798
	elseif tonumber(gmcproomid) == 38792 then
		location = "3n3w"
	elseif tonumber(gmcproomid) == 38793 then
		location = "3n2w"
	elseif tonumber(gmcproomid) == 38794 then
		location = "3n1w"
	elseif tonumber(gmcproomid) == 38795 then
		location = "3n"
	elseif tonumber(gmcproomid) == 38796 then
		location = "3n1e"
	elseif tonumber(gmcproomid) == 38797 then
		location = "3n2e"
	elseif tonumber(gmcproomid) == 38798 then
		location = "3n3e"
	-- 4n - 38799 - 38805
	elseif tonumber(gmcproomid) == 38799 then
		location = "4n3w"
	elseif tonumber(gmcproomid) == 38800 then
		location = "4n2w"
	elseif tonumber(gmcproomid) == 38801 then
		location = "4n1w"
	elseif tonumber(gmcproomid) == 38802 then
		location = "4n"	
	elseif tonumber(gmcproomid) == 38803 then
		location = "4n1e"
	elseif tonumber(gmcproomid) == 38804 then
		location = "4n2e"
	elseif tonumber(gmcproomid) == 38805 then
		location = "4n3e"	
	-- 5n - 38806 - 38812
	elseif tonumber(gmcproomid) == 38806 then
		location = "5n3w"
	elseif tonumber(gmcproomid) == 38807 then
		location = "5n2w"
	elseif tonumber(gmcproomid) == 38808 then
		location = "5n1w"
	elseif tonumber(gmcproomid) == 38809 then
		location = "5n"	
	elseif tonumber(gmcproomid) == 38810 then
		location = "5n1e"
	elseif tonumber(gmcproomid) == 38811 then
		location = "5n2e"
	elseif tonumber(gmcproomid) == 38812 then
		location = "5n3e"
	end

	if location == "" or location == nil then
		ColourNote(err_colour, "", "You are not in one of the seven blocking locations, please move and try again.")
	else
		if IFFragCount  > 0 then
			SendNoEcho (reportchannel .. " @D[@RIcefall@D] @G" .. location .. " @R" .. IFFragCount .. " @Dfrag(s)@w")
		else
			ColourNote(err_colour, "" , "There are currently no fragments in this room.")
		end
	end
end

function Epic_Consider(name, line, wc)
	replacements = { 
		["a"] = "",
		["A"] = "",
		["an"] = "",
		["An"] = "",
		["the"] = "",
		["The"] = "",
		["of"] = "",
		["Of"] = "",
	}
	
	mobname = string.lower(wc[1])
	
	if Trim(mobname) == "an energized ruby fragment" then 			
		IFFragCount = IFFragCount + 1
	end
end

function IcefallFragMovement(name, line, wc)
	fragdir = string.upper(wc[1])
	ColourNote(msg_colour, "", "an energized ruby fragment moved ", help_command_colour, "", fragdir)
end

-------------------------------------------
------------ GET ROOM FUNCTION ------------
-------------------------------------------
function GetRoom()
	Send_GMCP_Packet("request room")

	gmcparea = gmcp("room.info.zone")
	gmcproomid = gmcp("room.info.num")	
end

--------------------------------------------------
----------------- HELP FUNCTION  -----------------
--------------------------------------------------
function tif_help()
	local title = "Tallimos' IF2 Frag Counter"
	local title2 = noteline
		
	local leng = tonumber(string.len(title))
	local leng2 = tonumber(string.len(title2))
	
	local spacing = 0
	local lendif = 0
	
	if leng > leng2 then
	else
		lendif = leng2 - leng
		lendif = lendif * 0.5
	end

	spacing = string.rep(" ", lendif)
	
	ColourNote(help_colour, "", spacing, help_command_colour, "", title)
	ColourNote(help_colour, "", noteline)
	
	ColourNote(help_command_colour, "", "tif                 ", help_colour, "", " - counts the number of icefall 2 fragments currently in your room then")
	ColourNote(help_colour, "", "                       displays how many along with your current room. i.e. gt 3n 5")
	
	ColourNote(help_command_colour, "", "tif report <channel>", help_colour, "", " - sets the channel in which you want to display the count")
	
	ColourNote(help_command_colour, "", "tif report          ", help_colour, "", " - displays which channel the user has chosen to display the count")
	
	Note("")
	
	ColourNote("red", "", "PLEASE NOTE:", help_colour, "", " the user can also use ", help_command_colour, "", "iffrag", help_colour, "", " and ", help_command_colour, "", "ifrag", help_colour, "", " in place of tif.")
	
	ColourNote(help_colour, "", noteline)
	Note("")
end	-- tee_help_icefall

--=================================================================================
-- Called when plugin receives telnet data - main entry point for actually running
-- the plugin.
--=================================================================================
function OnPluginBroadcast (msg, id, name, text)
	-- Look for GMCP handler.
	if (id == '3e7dedbe37e44942dd46d264') then
		if (text == 'reload') then
			-- invalidate current data
			return
		end
	end
end

function GetSavedData()
	if GetVariable ("ifragpastfirstinstall") == "true" then
		assert (loadstring (GetVariable ("reportchannel") or "")) ()
	else
		reportchannel =  "gt"
	end

	SaveState()
end

function OnPluginInstall ()
	PLUGIN_VERSION  = GetPluginInfo(GetPluginID(), 19)
	PLUGIN_NAME   = GetPluginInfo(GetPluginID(), 1)

	GetSavedData()	

	ColourNote(help_colour, "", "Thank you for installing ", qty_colour, "", "Tallimos' IF2 Frag Counter v" ..  PLUGIN_VERSION, help_colour, "", ". Please see ", help_command_colour, "", "tif help", help_colour, "", " for more information.")
	Note("")
end

function OnPluginEnable()
	GetSavedData()   
end -- OnPluginEnable

function OnPluginSaveState ()
	SetVariable ("reportchannel", "reportchannel = " .. serialize.save_simple (reportchannel))

	SetVariable ("ifragpastfirstinstall", "true")
end -- OnPluginSaveState

]]>
</script>
</muclient>
